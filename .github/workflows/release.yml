name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release'
        required: true
        type: string

permissions:
  contents: write
  id-token: write  # Required for cosign OIDC signing

jobs:
  release:
    runs-on: macos-latest  # Changed to macOS for Apple code signing
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.23'

    - name: Install cosign
      uses: sigstore/cosign-installer@v3.7.0
      with:
        cosign-release: 'v2.4.1'

    - name: Import Apple Code Signing Certificate
      if: github.event_name != 'workflow_dispatch' || github.ref_type == 'tag'
      env:
        MACOS_CERTIFICATE: ${{ secrets.MACOS_CERTIFICATE }}
        MACOS_CERTIFICATE_PWD: ${{ secrets.MACOS_CERTIFICATE_PWD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create variables
        CERTIFICATE_PATH="$RUNNER_TEMP/build_certificate.p12"
        KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"

        # Import certificate from secrets
        echo -n "$MACOS_CERTIFICATE" | base64 --decode -o "$CERTIFICATE_PATH"

        # Create temporary keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
        security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

        # Import certificate to keychain
        security import "$CERTIFICATE_PATH" -P "$MACOS_CERTIFICATE_PWD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
        security list-keychain -d user -s "$KEYCHAIN_PATH"

        # Verify certificate is available
        security find-identity -v -p codesigning "$KEYCHAIN_PATH"

    - name: Run tests
      run: go test -v ./... -skip "TestMigrateWatsonCommandErrors|TestMigrateTimewarriorCommandIntegration|TestMigrateTimewarriorCommandErrors|TestMigrateEdgeCases"

    - name: Debug Telemetry Configuration
      run: |
        echo "=== Telemetry Debug Information ==="
        echo "Segment Key present: $([[ -n \"$RUNE_SEGMENT_WRITE_KEY\" ]] && echo 'YES' || echo 'NO')"
        echo "Sentry DSN present: $([[ -n \"$RUNE_SENTRY_DSN\" ]] && echo 'YES' || echo 'NO')"
        if [[ -n "$RUNE_SEGMENT_WRITE_KEY" ]]; then
          echo "Segment Key length: ${#RUNE_SEGMENT_WRITE_KEY}"
          echo "Segment Key (first 10 chars): ${RUNE_SEGMENT_WRITE_KEY:0:10}..."
        fi
        if [[ -n "$RUNE_SENTRY_DSN" ]]; then
          echo "Sentry DSN length: ${#RUNE_SENTRY_DSN}"
          echo "Sentry DSN (first 30 chars): ${RUNE_SENTRY_DSN:0:30}..."
        fi
        echo "=== End Telemetry Debug ==="
      env:
        RUNE_SEGMENT_WRITE_KEY: ${{ secrets.RUNE_SEGMENT_WRITE_KEY }}
        RUNE_SENTRY_DSN: ${{ secrets.RUNE_SENTRY_DSN }}

    - name: Create Sentry Release
      uses: getsentry/action-release@v1
      env:
         SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
         SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
         SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      with:
         environment: production
         version: ${{ github.ref_name }}

    - name: Generate Homebrew App Token
      id: homebrew-app-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ secrets.HOMEBREW_APP_ID }}
        private-key: ${{ secrets.HOMEBREW_APP_PRIVATE_KEY }}
        owner: ferg-cod3s
        repositories: homebrew-tap

    - name: Run GoReleaser
      uses: goreleaser/goreleaser-action@v5
      with:
        distribution: goreleaser
        version: v2.11.0
        args: release --clean
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        HOMEBREW_TAP_PAT: ${{ steps.homebrew-app-token.outputs.token }}
        RUNE_SEGMENT_WRITE_KEY: ${{ secrets.RUNE_SEGMENT_WRITE_KEY }}
        RUNE_SENTRY_DSN: ${{ secrets.RUNE_SENTRY_DSN }}
        COSIGN_EXPERIMENTAL: 1
        # Apple Code Signing
        MACOS_SIGN_IDENTITY: ${{ secrets.MACOS_SIGN_IDENTITY }}
        # Apple Notarization
        MACOS_NOTARY_ISSUER_ID: ${{ secrets.MACOS_NOTARY_ISSUER_ID }}
        MACOS_NOTARY_KEY_ID: ${{ secrets.MACOS_NOTARY_KEY_ID }}
        MACOS_NOTARY_KEY: ${{ secrets.MACOS_NOTARY_KEY }}

    - name: Test Telemetry Integration
      run: |
        echo "=== Testing Built Binary Telemetry ==="
        # Find the built binary (GoReleaser puts it in dist/)
        BINARY_PATH=$(find dist/ -name "rune" -type f | head -1)
        if [[ -n "$BINARY_PATH" ]]; then
          echo "Testing binary: $BINARY_PATH"
          chmod +x "$BINARY_PATH"
          echo "Running telemetry test with debug output..."
          RUNE_DEBUG=true "$BINARY_PATH" --version || echo "Binary test failed"
        else
          echo "No binary found in dist/ directory"
          ls -la dist/ || echo "dist/ directory not found"
        fi
        echo "=== End Telemetry Test ==="
    - name: Finalize Sentry Release
      uses: getsentry/action-release@v1
      env:
        SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
        SENTRY_ORG: ${{ secrets.SENTRY_ORG }}
        SENTRY_PROJECT: ${{ secrets.SENTRY_PROJECT }}
      with:
        environment: production
        version: ${{ github.ref_name }}
        finalize: true

    - name: Clean up keychain
      if: always() && (github.event_name != 'workflow_dispatch' || github.ref_type == 'tag')
      run: |
        KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
        if [ -f "$KEYCHAIN_PATH" ]; then
          security delete-keychain "$KEYCHAIN_PATH"
        fi
