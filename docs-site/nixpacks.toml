providers = ["node"]

[variables]
NODE_ENV = "production"

[phases.setup]
# Install nginx and curl for bun installation
nixPkgs = ["nginx", "curl", "unzip"]
cmds = [
  "curl -fsSL https://bun.sh/install | bash",
  "export PATH=\"$HOME/.bun/bin:$PATH\""
]

[phases.install]
# Install dependencies using Bun
cmds = [
  "export PATH=\"$HOME/.bun/bin:$PATH\"",
  "bun install --frozen-lockfile"
]

[phases.build]
# Build the application using Bun and setup nginx
cmds = [
  "export PATH=\"$HOME/.bun/bin:$PATH\"",
  "bun run build",
  "mkdir -p /usr/share/nginx/html",
  "cp -r dist/* /usr/share/nginx/html/",
  "cp nginx.conf /etc/nginx/nginx.conf"
]

[start]
# Start command for production - use nginx to serve static files
cmd = "nginx -g 'daemon off;'"

[staticAssets]
# Serve static files from dist directory
dir = "dist"

[cache]
# Cache node_modules and Astro build cache
paths = [
  "node_modules",
  ".astro"
]
