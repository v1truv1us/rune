providers = ["node"]

[variables]
NODE_ENV = "production"

[phases.setup]
# Install nginx for serving static files
nixPkgs = ["nginx"]

[phases.install]
# Install dependencies using npm (compatible with bun.lock)
cmds = ["npm install"]

[phases.build]
# Build the application and setup nginx
cmds = [
  "npm run build",
  "mkdir -p /usr/share/nginx/html",
  "cp -r dist/* /usr/share/nginx/html/",
  "cp nginx.conf /etc/nginx/nginx.conf"
]

[start]
# Start command for production - use nginx to serve static files
cmd = "nginx -g 'daemon off;'"

[staticAssets]
# Serve static files from dist directory
dir = "dist"

[cache]
# Cache node_modules and Astro build cache
paths = [
  "node_modules",
  ".astro"
]
